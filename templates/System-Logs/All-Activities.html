{% extends "base.html" %}
{% block extrastyles %}
{% endblock extrastyles %}
{% block extrajs %}
{% endblock extrajs %}
{% block content %}
    <div class="page-inner ms-2 me-2">
        <!-- Page Header & Breadcrumbs -->
        <header class="">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item">
                        <a href="{% url 'AdminDashboard' %}">Dashboard</a>
                    </li>
                    <li class="breadcrumb-item">
                        <a href="#">System Logs</a>
                    </li>
                    <li class="breadcrumb-item active" aria-current="page">All Activities</li>
                </ol>
            </nav>
            <div class="d-flex justify-content-between align-items-center">
                <h1 class="page-title">Audit Trail</h1>
                <a href="{% url 'download_report' %}">Export Logs</a>
            </div>
        </header>
        <!-- Page Content Section -->
        <div class="page-section">
            <div class="card card-fluid">
                <!-- Toolbar: Filter & Search -->
                <div class="card-header border-bottom-0">
                    <div class="d-flex align-items-center">
                        <!-- FILTER DROPDOWN -->
                        <div class="form-group mb-0 mr-3">
                            <select class="custom-select" id="logFilter">
                                <option value="all" selected>Action: All</option>
                                <option value="create">Created</option>
                                <option value="update">Updated</option>
                                <option value="delete">Deleted</option>
                                <option value="login">Login/Logout</option>
                            </select>
                        </div>
                        <!-- SEARCH INPUT -->
                        <div class="form-group mb-0 flex-grow-1">
                            <div class="input-group input-group-alt">
                                <div class="input-group-prepend">
                                    <span class="input-group-text"><span class="oi oi-magnifying-glass"></span></span>
                                </div>
                                <input type="text"
                                       class="form-control"
                                       id="logSearch"
                                       placeholder="Search logs (e.g., 'Deleted Batch', 'admin_user')">
                            </div>
                        </div>
                    </div>
                </div>
                <!-- THE LOGS LIST CONTAINER -->
                <!-- We removed the hardcoded items. JS will fill this div. -->
                <!-- .table-responsive -->
                <div class="table-responsive">
                    <!-- .table -->
                    <table class="table table-hover">
                        <!-- thead -->
                        <thead class="thead-dark">
                            <tr>
                                <th style="min-width:100px">Action</th>
                                <th style="min-width:300px">Description</th>
                                <th>User</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <!-- /tbody -->
                        <tbody id="logsTableBody">
                            {% for log in activities %}
                                <!-- We add data-type and data-search attributes for the JS filter to read -->
                                <tr class="log-row"
                                    data-type="{{ log.type }}"
                                    data-search="{{ log.description }} {{ log.target|default:'' }} {{ log.user }}">
                                    <td class="align-middle">
                                        <span class="badge badge-subtle {{ log.badge_class }}">{{ log.action_text }}</span>
                                    </td>
                                    <td class="align-middle">
                                        {{ log.description }}:
                                        {% if log.target %}<strong>{{ log.target }}</strong>{% endif %}
                                    </td>
                                    <td class="align-middle">
                                        <span class="text-dark font-weight-bold">{{ log.user }}</span>
                                        <div class="small text-muted d-block d-md-none">
                                            {% if log.type == 'login' %}
                                                User
                                            {% else %}
                                                Performed by
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td class="align-middle text-muted">{{ log.date }}</td>
                                </tr>
                            {% empty %}
                                <!-- Initial Empty State (if database is empty) -->
                                <tr>
                                    <td colspan="4" class="text-center py-4 text-muted">
                                        <i class="fas fa-info-circle mb-2"></i>
                                        <br>
                                        No activity logs found in the database.
                                    </td>
                                </tr>
                            {% endfor %}
                            <!-- Hidden "No Results" row for JS Search -->
                            <tr id="no-search-results" style="display: none;">
                                <td colspan="4" class="text-center py-4 text-muted">
                                    <i class="fas fa-search mb-2"></i>
                                    <br>
                                    No activities found matching your criteria.
                                </td>
                            </tr>
                        </tbody>
                        <!-- /tbody -->
                    </table>
                    <tfoot>
                        <ul class="pagination justify-content-center mt-4">
                            <li class="page-item disabled">
                                <a class="page-link" href="#" tabindex="-1">
                                    <i class="fa fa-lg fa-angle-left"></i>
                                </a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="#">1</a>
                            </li>
                            <li class="page-item disabled">
                                <a class="page-link" href="#" tabindex="-1">...</a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="#">13</a>
                            </li>
                            <li class="page-item active">
                                <a class="page-link" href="#">14</a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="#">15</a>
                            </li>
                            <li class="page-item disabled">
                                <a class="page-link" href="#" tabindex="-1">...</a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="#">24</a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="#">
                                    <i class="fa fa-lg fa-angle-right"></i>
                                </a>
                            </li>
                        </ul>
                    </tfoot>
                    <!-- /.table -->
                </div>
                <!-- /.table-responsive -->
            </div>
        </div>
        <!-- ========================================== -->
        <!-- 4. DATA BRIDGE: BACKEND TO FRONTEND        -->
        <!-- ========================================== -->
        <!-- This converts the Python list into a valid JSON object hidden in the HTML -->
        {{ activities|json_script:"activity-data" }}
    </div>
    <!-- /.page-inner -->
{% endblock content %}
{% block bottomjs %}
    <script>
        document.addEventListener("DOMContentLoaded", function() {
        // DOM Elements
        const searchInput = document.getElementById('logSearch');
        const filterSelect = document.getElementById('logFilter');
        const tableRows = document.querySelectorAll('.log-row'); // The rows created by Django
        const noResultsRow = document.getElementById('no-search-results');
        function applyFilters() {
        const searchText = searchInput.value.toLowerCase().trim();
        const filterType = filterSelect.value;
        let visibleCount = 0;
        tableRows.forEach(row => {
        // Read the data attributes we added in HTML
        const rowType = row.getAttribute('data-type');
        const rowSearchText = row.getAttribute('data-search').toLowerCase();
        // 1. Check Type (exact match or 'all')
        const matchesType = (filterType === 'all') || (rowType === filterType);
        // 2. Check Search (includes text)
        const matchesSearch = rowSearchText.includes(searchText);
        // Toggle Visibility
        if (matchesType && matchesSearch) {
        row.style.display = ''; // Show
        visibleCount++;
        } else {
        row.style.display = 'none'; // Hide
        }
        });
        // Toggle the "No Results" message based on visible rows
        if (visibleCount === 0 && tableRows.length > 0) {
        noResultsRow.style.display = '';
        } else {
        noResultsRow.style.display = 'none';
        }
        }
        // Event Listeners
        if(searchInput) searchInput.addEventListener('keyup', applyFilters);
        if(filterSelect) filterSelect.addEventListener('change', applyFilters);
        });
    </script>
    <script>
$(document).ready(function() {

    // --- jQuery Ctrl + F Override ---
    $(document).on('keydown', function(e) {
        // Check if Ctrl (Windows) or Meta (Mac Cmd) is pressed
        // AND check if the key pressed is 'f' or 'F' (Key code 70)
        if ((e.ctrlKey || e.metaKey) && (e.key === 'f' || e.key === 'F')) {
            
            // 1. Stop the browser's native Find tool
            e.preventDefault();

            // 2. Select the search input using the ID selector ($)
            var searchInput = $('#logSearch');

            // 3. Focus on the input
            searchInput.focus();
            
            // Optional: visual effect to show the user where the cursor went
            // searchInput.css('background-color', '#fff3cd').animate({backgroundColor: '#ffffff'}, 500);
        }
    });

    // ... Your other jQuery or JS code ...

});
    </script>
{% endblock bottomjs %}

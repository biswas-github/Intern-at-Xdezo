{% extends "base.html" %}
{% block extrastyles %}
{% endblock extrastyles %}
{% block extrajs %}
{% endblock extrajs %}
{% block content %}
    <div class="page-inner ms-2 me-2">
        <!-- Page Header & Breadcrumbs -->
        <header class="page-title-bar mb-0 mb-sm-0">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item">
                        <a href="{% url 'AdminDashboard' %}">Dashboard</a>
                    </li>
                    <li class="breadcrumb-item active" aria-current="page">User Management</li>
                </ol>
            </nav>
            <div class="d-flex justify-content-between align-items-center">
                <h1 class="page-title">
                    System Users <span> <a href="{% url 'AddSystemUser' %}" class="text-decoration-none">
                    <i style="font-size: 0.5em;"  class="fas fa-user-plus"></i>
                </a></span>
            </h1>
        </div>
    </header>
    <!-- Page Content Section -->
    <div class="page-section">
        <section class="card card-fluid">
            <!-- Toolbar: Search & Filter -->
            <header class="card-header border-bottom-0">
                <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between">
                    <!-- Filter Dropdown -->
                    <div class="form-group mb-3 mb-md-0">
                        <select id="roleFilter" class="custom-select" style="min-width: 150px;">
                            <option value="all" selected>All Roles</option>
                            <option value="ADMIN">Admin</option>
                            <option value="INSTRUCTOR">Instructor</option>
                            <option value="ACCOUNTANT">Accountant</option>
                            <option value="VIEWER">Viewer</option>
                        </select>
                    </div>
                    <!-- Search Input -->
                    <div class="input-group input-group-alt" style="max-width: 300px;">
                        <div class="input-group-prepend">
                            <span class="input-group-text"><span class="oi oi-magnifying-glass"></span></span>
                        </div>
                        <input id="table-search"
                               type="text"
                               class="form-control"
                               placeholder="Search name, username or email...">
                        <div class="input-group-append">
                            <button id="clear-search"
                                    type="button"
                                    class="btn btn-secondary"
                                    style="display:none">
                                <i class="fa fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </header>
            <!-- .table-responsive -->
            <div class="table-responsive">
                <table class="table table-hover" id="userTable">
                    <thead class="thead-dark">
                        <tr>
                            <!-- 1. Profile: Visible Always -->
                            <th style="min-width:200px">User Profile</th>
                            <!-- 2. Role: Hidden on Mobile (XS) -->
                            <th class="d-none d-sm-table-cell">Role</th>
                            <!-- 3. Email: Hidden on Mobile & Tablet (XS/SM/MD) -->
                            <th class="d-none d-lg-table-cell d-none d-md-table-cell">Email</th>
                            <!-- 4. Actions: Visible Always -->
                            <th style="min-width:100px; text-align:right;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="userTableBody">
                        {% for user in users %}
                            <tr class="user-row"
                                data-search="{{ user.get_full_name }} {{ user.username }} {{ user.email }}"
                                data-role="{{ user.role }}">
                                <!-- 1. User Profile -->
                                <td class="align-middle">
                                    <div class="d-flex align-items-center">
                                        <div>
                                            <span class="d-block text-dark font-weight-bold">{{ user.get_full_name|default:user.username }}</span>
                                            <!-- Mobile Only Details: Role & Email -->
                                            <div class="d-block d-sm-none mt-1 small d-none d-md-table-cell">
                                                <div class="text-muted mb-1">{{ user.email }}</div>
                                            </div>
                                        </div>
                                    </div>
                                </td>
                                <!-- 2. Role -->
                                <td class="align-middle d-none d-sm-table-cell">
                                    {% if user.role == 'ADMIN' %}
                                        <span class="badge badge-subtle badge-purple">Admin</span>
                                    {% elif user.role == 'INSTRUCTOR' %}
                                        <span class="badge badge-subtle badge-primary">Instructor</span>
                                    {% elif user.role == 'ACCOUNTANT' %}
                                        <span class="badge badge-subtle badge-info">Accountant</span>
                                    {% else %}
                                        <span class="badge badge-subtle badge-secondary">Viewer</span>
                                    {% endif %}
                                </td>
                                <!-- 3. Email -->
                                <td class="align-middle d-none d-lg-table-cell d-none d-md-table-cell">{{ user.email }}</td>
                                <!-- 4. Actions -->
                                <td class="align-middle text-right">
                                    <div class="d-flex flex-column flex-md-row gap-2 justify-content-end">
                                        <!-- View Button -->
                                        <button type="button"
                                                class="btn btn-sm btn-subtle-info"
                                                data-toggle="modal"
                                                data-target="#userDetailsModal"
                                                data-username="{{ user.username }}"
                                                data-fullname="{{ user.get_full_name }}"
                                                data-email="{{ user.email }}"
                                                data-role="{{ user.role }}"
                                                data-joined="{{ user.date_joined|date:'M d, Y' }}"
                                                onclick="populateUserModal(this)">View</button>
                                        <!-- Edit Button -->
                                        <a href="{% url 'EditUser' id=user.id %}"
                                           class="btn btn-sm bg-light text-dark mx-md-1 ">Edit</a>
                                        <!-- Delete Button -->
                                        <button type="button"
                                                class="btn btn-sm btn-subtle-danger"
                                                data-toggle="modal"
                                                data-target="#deleteUserModal"
                                                data-name="{{ user.get_full_name|default:user.username }}"
                                                data-delete-url="{% url 'DeleteUser' id=user.id %}"
                                                onclick="populateDeleteUserModal(this)">
                                            <i class="oi oi-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        {% empty %}
                            <tr>
                                <td colspan="4" class="text-center py-5 text-muted">
                                    <i class="fas fa-users fa-3x mb-3"></i>
                                    <br>
                                    No users found.
                                </td>
                            </tr>
                        {% endfor %}
                        <!-- No Results Row -->
                        <tr id="no-search-results" style="display: none;">
                            <td colspan="4" class="text-center py-5 text-muted">
                                <i class="fas fa-search mb-2"></i>
                                <br>
                                No users found matching your criteria.
                            </td>
                        </tr>
                    </tbody>
                </table>
                <tfoot>
                    <ul class="pagination justify-content-center mt-4">
                        <li class="page-item disabled">
                            <a class="page-link" href="#" tabindex="-1">
                                <i class="fa fa-lg fa-angle-left"></i>
                            </a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="#">1</a>
                        </li>
                        <li class="page-item disabled">
                            <a class="page-link" href="#" tabindex="-1">...</a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="#">13</a>
                        </li>
                        <li class="page-item active">
                            <a class="page-link" href="#">14</a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="#">15</a>
                        </li>
                        <li class="page-item disabled">
                            <a class="page-link" href="#" tabindex="-1">...</a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="#">24</a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="#">
                                <i class="fa fa-lg fa-angle-right"></i>
                            </a>
                        </li>
                    </ul>
                </tfoot>
            </div>
        </section>
    </div>
</div>
<!-- Modals -->
<!-- modals  -->
<!-- ================= 1. VIEW USER MODAL ================= -->
<div class="modal fade"
     id="userDetailsModal"
     tabindex="-1"
     role="dialog"
     aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">User Profile</h5>
                <button type="button"
                        class="btn-close"
                        data-dismiss="modal"
                        aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="table-responsive">
                    <table class="table table-bordered mb-0">
                        <tbody>
                            <tr>
                                <th class="bg-primary text-white" style="width: 35%;">Username</th>
                                <td id="modal_user_username"></td>
                            </tr>
                            <tr>
                                <th class="bg-light text-primary">Full Name</th>
                                <td id="modal_user_fullname"></td>
                            </tr>
                            <tr>
                                <th class="bg-primary text-white">Email</th>
                                <td id="modal_user_email"></td>
                            </tr>
                            <tr>
                                <th class="bg-light text-primary">Role</th>
                                <td>
                                    <span id="modal_user_role" class="badge"></span>
                                </td>
                            </tr>
                            <tr>
                                <th class="bg-primary text-white">Date Joined</th>
                                <td id="modal_user_joined"></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
<!-- ================= 2. DELETE CONFIRMATION MODAL ================= -->
<div class="modal fade"
     id="deleteUserModal"
     tabindex="-1"
     role="dialog"
     aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-danger text-center">Delete User</h5>
                <button type="button"
                        class="btn-close"
                        data-dismiss="modal"
                        aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body text-center">
                <div class="mb-3 text-danger">
                    <i class="fas fa-exclamation-triangle fa-3x"></i>
                </div>
                <p>
                    Are you sure you want to delete user <strong id="delete_modal_user_name"></strong>?
                </p>
                <small class="text-muted">This action will remove their access and cannot be undone.</small>
            </div>
            <div class="modal-footer justify-content-center">
                <button type="button" class="btn btn-muted" data-dismiss="modal">Cancel</button>
                <a href="#"
                   id="delete_modal_confirm_btn"
                   class="btn btn-secondary text-danger">Yes, Delete User</a>
            </div>
        </div>
    </div>
</div>
{% endblock content %}
{% block bottomjs %}
    <!-- js -->
    <script>
document.addEventListener("DOMContentLoaded", function() {
    
    // Selectors
    const searchInput = document.getElementById('table-search');
    const roleFilter = document.getElementById('roleFilter');
    const clearBtn = document.getElementById('clear-search');
    const tableRows = document.querySelectorAll('.user-row');
    const noResultsRow = document.getElementById('no-search-results');

    // --- Filter Function ---
    function filterUsers() {
        const searchText = searchInput.value.toLowerCase().trim();
        const roleVal = roleFilter.value; 
        let visibleCount = 0;

        tableRows.forEach(function(row) {
            // 1. Get Data
            const rowSearch = (row.getAttribute('data-search') || '').toLowerCase();
            const rowRole = row.getAttribute('data-role');

            // 2. Check Search
            const matchesSearch = rowSearch.includes(searchText);

            // 3. Check Role Filter
            const matchesRole = (roleVal === 'all') || (rowRole === roleVal);

            // 4. Final Toggle
            if (matchesSearch && matchesRole) {
                row.style.display = '';
                visibleCount++;
            } else {
                row.style.display = 'none';
            }
        });

        // Toggle No Results Message
        if (visibleCount === 0 && tableRows.length > 0) {
            if(noResultsRow) noResultsRow.style.display = '';
        } else {
            if(noResultsRow) noResultsRow.style.display = 'none';
        }

        // Toggle Clear Button
        if(clearBtn) clearBtn.style.display = (searchText.length > 0) ? 'block' : 'none';
    }

    // Attach Listeners
    if(searchInput) searchInput.addEventListener('keyup', filterUsers);
    if(roleFilter) roleFilter.addEventListener('change', filterUsers);

    if(clearBtn) {
        clearBtn.addEventListener('click', function() {
            searchInput.value = '';
            filterUsers();
        });
    }
});

// --- Populate View Modal ---
function populateUserModal(buttonElement) {
    const data = buttonElement.dataset;
    
    // 1. Text Fields
    document.getElementById('modal_user_username').textContent = data.username || 'N/A';
    document.getElementById('modal_user_fullname').textContent = data.fullname || 'N/A';
    document.getElementById('modal_user_email').textContent = data.email || 'N/A';
    document.getElementById('modal_user_joined').textContent = data.joined || 'N/A';

    // 2. Role Badge Logic
    const roleEl = document.getElementById('modal_user_role');
    const role = data.role || 'VIEWER';
    
    roleEl.textContent = role;
    roleEl.className = 'badge'; 
    
    const roleKey = role.trim().toUpperCase(); 

    if (roleKey === 'ADMIN') {
        roleEl.classList.add('badge-purple'); // Custom purple class in custom.css or substitute with badge-dark
    } else if (roleKey === 'INSTRUCTOR') {
        roleEl.classList.add('badge-primary');
    } else if (roleKey === 'ACCOUNTANT') {
        roleEl.classList.add('badge-info');
    } else {
        roleEl.classList.add('badge-secondary');
    }
}

// --- Populate Delete Modal ---
function populateDeleteUserModal(buttonElement) {
    const name = buttonElement.getAttribute('data-name');
    const deleteUrl = buttonElement.getAttribute('data-delete-url');
    
    document.getElementById('delete_modal_user_name').textContent = name;
    
    const confirmBtn = document.getElementById('delete_modal_confirm_btn');
    if (confirmBtn) confirmBtn.href = deleteUrl;
}
    </script>
    <script>
$(document).ready(function() {

    // --- jQuery Ctrl + F Override ---
    $(document).on('keydown', function(e) {
        // Check if Ctrl (Windows) or Meta (Mac Cmd) is pressed
        // AND check if the key pressed is 'f' or 'F' (Key code 70)
        if ((e.ctrlKey || e.metaKey) && (e.key === 'f' || e.key === 'F')) {
            
            // 1. Stop the browser's native Find tool
            e.preventDefault();

            // 2. Select the search input using the ID selector ($)
            var searchInput = $('#table-search');

            // 3. Focus on the input
            searchInput.focus();
            
            // Optional: visual effect to show the user where the cursor went
            // searchInput.css('background-color', '#fff3cd').animate({backgroundColor: '#ffffff'}, 500);
        }
    });

    // ... Your other jQuery or JS code ...

});
    </script>
{% endblock bottomjs %}

{% extends "base.html" %}
<!-- .extra js in head -->
{% block extrajs %}
{% endblock extrajs %}
{% block content %}
    <!-- ================================================== -->
    <!-- 1. DATA BRIDGE (Pass Django Data to JS)            -->
    <!-- ================================================== -->
    {{ chart_labels|json_script:"revenue-labels" }}
    {{ chart_data|json_script:"revenue-data" }}
    <!-- Assuming you will pass these for Enrollment later -->
    {{ enrollment_labels|json_script:"enrollment-labels" }}
    {{ enrollment_data|json_script:"enrollment-data" }}
    <!-- ================================================== -->
    <!-- 2. PAGE HEADER                                     -->
    <!-- ================================================== -->
    <header class="py-3 mb-3 border-bottom d-sm-flex flex-row justify-content-between">
        <div class="d-flex justify-content-between align-items-center  ">
            <div class="mx-2 ">
                <h1 class="page-title h3 font-weight-bold">Dashboard</h1>
                <p class="text-muted mb-0">Intake overview & Analytics</p>
            </div>
            <!-- Optional: Date Range Picker could go here -->
        </div>
        <div>
            <a class="btn btn-outline-primary"
               href="{% url 'Classroom_schedule_today' %}">View Today Schedule</a>
        </header>
        <!-- ================================================== -->
        <!-- 4. ANALYTICS (Charts)                              -->
        <!-- ================================================== -->
        <div class="page-section mb-4">
            <div class="row g-3">
                <!-- Chart 1: Revenue -->
                <div class="col-12 col-lg-6">
                    <div class="card card-fluid shadow-sm border-0 h-100">
                        <div class="card-header border-0 bg-transparent d-flex justify-content-between align-items-center mt-2">
                            <h5 class="card-title mb-0">Monthly Revenue</h5>
                            <span class="badge badge-success">Rs. {{ total_revenue|default:"0" }}</span>
                        </div>
                        <div class="card-body pt-0">
                            <!-- Fixed Height Container for Responsiveness -->
                            <div class="chart-container"
                                 style="position: relative;
                                        height: 300px;
                                        width: 100%">
                                <canvas id="revenueChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Chart 2: Enrollment -->
                <div class="col-12 col-lg-6">
                    <div class="card card-fluid shadow-sm border-0 h-100">
                        <div class="card-header border-0 bg-transparent d-flex justify-content-between align-items-center mt-2">
                            <h5 class="card-title mb-0">Enrollment Trends</h5>
                            <span class="badge badge-primary">This Year</span>
                        </div>
                        <div class="card-body pt-0">
                            <div class="chart-container"
                                 style="position: relative;
                                        height: 300px;
                                        width: 100%">
                                <canvas id="enrollmentChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- ================================================== -->
        <!-- 3. KPI CARDS (Responsive Grid)                     -->
        <!-- ================================================== -->
        <div class="page-section mb-4">
            <div class="row g-3">
                <!-- g-3 adds spacing between cols -->
                <!-- Active students -->
                <div class="col-12 col-sm-6 col-xl-3 mb-1">
                    <div class="card card-fluid shadow-sm border-0 h-100">
                        <div class="card-body text-center p-4">
                            <div class="d-flex align-items-center justify-content-center mb-2">
                                <span class="badge badge-subtle badge-primary rounded-pill px-3 py-1 text-uppercase small">Active</span>
                            </div>
                            <h2 class="mb-0 display-4 font-weight-bold">{{ active_students }}</h2>
                            <small class="text-muted">Currently enrolled</small>
                        </div>
                    </div>
                </div>
                <!-- Ongoing batches -->
                <div class="col-12 col-sm-6 col-xl-3 mb-1">
                    <div class="card card-fluid shadow-sm border-0 h-100">
                        <div class="card-body text-center p-4">
                            <div class="d-flex align-items-center justify-content-center mb-2">
                                <span class="badge badge-subtle badge-info rounded-pill px-3 py-1 text-uppercase small">Batches</span>
                            </div>
                            <h2 class="mb-0 display-4 font-weight-bold">{{ today_sessions }}</h2>
                            <small class="text-muted">ongoing batches</small>
                        </div>
                    </div>
                </div>
                <!-- Today sessions -->
                <div class="col-12 col-sm-6 col-xl-3 mb-1">
                    <div class="card card-fluid shadow-sm border-0 h-100">
                        <div class="card-body text-center p-4">
                            <div class="d-flex align-items-center justify-content-center mb-2">
                                <span class="badge badge-subtle badge-warning rounded-pill px-3 py-1 text-uppercase small">Today</span>
                            </div>
                            <h2 class="mb-0 display-4 font-weight-bold">{{ today_sessions }}</h2>
                            <small class="text-muted">Classes scheduled</small>
                        </div>
                    </div>
                </div>
                <!-- Pending dues -->
                <div class="col-12 col-sm-6 col-xl-3">
                    <div class="card card-fluid shadow-sm border-0 h-100">
                        <div class="card-body text-center p-4">
                            <div class="d-flex align-items-center justify-content-center mb-2">
                                <span class="badge badge-subtle badge-danger rounded-pill px-3 py-1 text-uppercase small">Dues</span>
                            </div>
                            <h2 class="mb-0 display-5 font-weight-bold text-danger">{{ pending_dues }}</h2>
                            <small class="text-muted">Total Pending (Rs)</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- ================================================== -->
        <!-- 5. MAIN OPERATIONS (Split Layout)                  -->
        <!-- ================================================== -->
        <div class="page-section">
            <div class="row g-3">
                <!-- LEFT COLUMN: Data Tables (Full width on Mobile) -->
                <div class="col-12 col-lg-8">
                    <!-- Upcoming schedules -->
                    <div class="card card-fluid shadow-sm border-0 mb-4">
                        <div class="card-header border-0 bg-transparent d-flex justify-content-between align-items-center">
                            <h6 class="mb-0 font-weight-bold">Upcoming schedules</h6>
                            <a href="{% url 'ViewSchedule' %}" class="btn btn-sm btn-subtle-primary">View all</a>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover mb-0 align-middle">
                                <thead class="thead-light">
                                    <tr>
                                        <th>Time</th>
                                        <!-- Date combined with Time for mobile space? Or kept separate -->
                                        <th>Batch</th>
                                        <th class="d-none d-sm-table-cell">Classroom</th>
                                        <th class="d-none d-sm-table-cell">Instructor</th>
                                        <th class="text-end">Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for schedule in upcoming_schedules %}
                                        <tr>
                                            <td>
                                                <!-- Display Date -->
                                                <div class="font-weight-bold">{{ schedule.date|date:"d M" }}</div>
                                                <!-- Display Start - End Time -->
                                                <small class="text-muted">{{ schedule.start_time|time:"H:i" }} â€“ {{ schedule.end_time|time:"H:i" }}</small>
                                            </td>
                                            <td>{{ schedule.batch.name }}</td>
                                            <!-- Hide Room/Instructor on small mobile screens -->
                                            <td class="d-none d-sm-table-cell">{{ schedule.classroom.name|default:"No Room" }}</td>
                                            <td class="d-none d-sm-table-cell">{{ schedule.instructor.full_name|default:"TBA" }}</td>
                                            <td class="text-end">
                                                <span class="badge badge-subtle badge-success">{{ schedule.get_status_display }}</span>
                                            </td>
                                        </tr>
                                    {% empty %}
                                        <tr>
                                            <td colspan="5" class="text-center py-3">No upcoming classes scheduled.</td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <!-- Recent Payments -->
                    <div class="card card-fluid shadow-sm border-0 mb-4">
                        <div class="card-header border-0 bg-transparent d-flex justify-content-between align-items-center">
                            <h6 class="mb-0 font-weight-bold">Recent payments</h6>
                            <a href="{% url 'ViewPayment' %}" class="btn btn-sm btn-subtle-primary">Finance</a>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover mb-0 align-middle">
                                <thead class="thead-light">
                                    <tr>
                                        <th>Date</th>
                                        <th>Student</th>
                                        <th class="d-none d-sm-table-cell">Method</th>
                                        <th class="text-end">Amount</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for pay in recent_payments %}
                                        <tr>
                                            <td>{{ pay.date|date:"d M" }}</td>
                                            <td>
                                                <div class="font-weight-bold">
                                                    {% if pay.student %}
                                                        {{ pay.student.full_name }}
                                                    {% else %}
                                                        deleted
                                                    {% endif %}
                                                </div>
                                            </td>
                                            <td class="d-none d-sm-table-cell">
                                                <span class="badge badge-subtle badge-secondary">{{ pay.method }}</span>
                                            </td>
                                            <td class="text-end font-weight-bold text-success">Rs. {{ pay.amount }}</td>
                                        </tr>
                                    {% empty %}
                                        <tr>
                                            <td colspan="4" class="text-center py-3">No recent payments found.</td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <!-- Available Rooms -->
                    <div class="card card-fluid shadow-sm border-0 mb-4">
                        <div class="card-header border-0 bg-transparent d-flex justify-content-between align-items-center">
                            <h6 class="mb-0 font-weight-bold">Available rooms</h6>
                            <a href="{% url 'FreeRoom' %}" class="btn btn-sm btn-subtle-primary">Check all</a>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover mb-0 align-middle">
                                <thead class="thead-light">
                                    <tr>
                                        <th>Room</th>
                                        <th></th>
                                        <th class="text-end">Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for room in rooms %}
                                        <tr>
                                            <td>
                                                {{ room.name }}
                                                <small class="text-muted">(Cap: {{ room.capacity }})</small>
                                            </td>
                                            <!-- Static time placeholder because dynamic availability is complex -->
                                            <td></td>
                                            <td class="text-end">
                                                {% if room.is_active %}
                                                    <span class="badge badge-subtle badge-success">Active</span>
                                                {% else %}
                                                    <span class="badge badge-subtle badge-danger">Maintenance</span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                    {% empty %}
                                        <tr>
                                            <td colspan="3">No rooms found.</td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <!-- End Left Col -->
                <!-- RIGHT COLUMN: Sticky Quick Actions (HIDDEN ON PHONE/TABLET) -->
                <!-- 'd-none d-lg-block' ensures this disappears on small screens -->
                <!-- 1. CSS FIX: This is crucial. Put this style block right before the column or in your <head> -->
                <style>
  /* Force parents to allow sticky positioning */
  body, html, .app-main, .page-inner, .wrapper, .page-section, .content {
      overflow: visible !important; 
  }

  /* The Sticky Container Class */
  .sticky-sidebar {
      position: -webkit-sticky !important; /* Safari */ 
      position: sticky !important ;
      top: 13rem !important ;/* Adjust based on your Navbar height (approx 100px) */
      z-index: 100 !important;
      align-self: flex-start !important; /* Ensures it doesn't stretch weirdly */
  }
                </style>
                <!-- 2. THE HTML STRUCTURE -->
                <div class="d-none d-lg-block col-lg-4">
                    <!-- The wrapper with the sticky class -->
                    <div class="sticky-sidebar">
                        <div class="card card-fluid shadow-sm border-0 mb-3">
                            <div class="card-header border-0 bg-light py-3">
                                <span class="card-title font-weight-bold text-uppercase small ls-1 text-primary">
                                    <i class="fa fa-bolt me-2"></i>Quick Actions
                                </span>
                            </div>
                            <div class="card-body">
                                <div class="d-grid gap-3">
                                    <a href="{% url 'DataManagementStudent' %}"
                                       class="btn btn-outline-primary text-start shadow-sm mb-2">New student</a>
                                    <a href="{% url 'Batch' %}"
                                       class="btn btn-outline-primary text-start shadow-sm mb-2">New batch</a>
                                    <a href="{% url 'AddSchedule' %}"
                                       class="btn btn-outline-primary text-start shadow-sm">Schedule class</a>
                                    <a href="{% url 'AddPayment' %}"
                                       class="btn btn-outline-primary text-start shadow-sm">Record payment</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- ================================================== -->
        <!-- 6. JAVASCRIPT LOGIC                                -->
        <!-- ================================================== -->
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script>
document.addEventListener("DOMContentLoaded", function() {
// ------------------------------------------------
// 1. REVENUE CHART (Green Theme)
// ------------------------------------------------
const revCtx = document.getElementById('revenueChart');
if (revCtx) {
// Safe Data Fetching
const revLabelElement = document.getElementById('revenue-labels');
const revDataElement = document.getElementById('revenue-data');
const labels = revLabelElement ? JSON.parse(revLabelElement.textContent) : ['Jan', 'Feb', 'Mar', 'Apr'];
const dataPoints = revDataElement ? JSON.parse(revDataElement.textContent) : [0, 0, 0, 0];
const ctx = revCtx.getContext('2d');
// Gradient
let gradient = ctx.createLinearGradient(0, 0, 0, 400);
gradient.addColorStop(0, 'rgba(40, 167, 69, 0.4)'); // Green opacity
gradient.addColorStop(1, 'rgba(40, 167, 69, 0.0)');
new Chart(ctx, {
type: 'line',
data: {
labels: labels,
datasets: [{
label: 'Revenue',
data: dataPoints,
borderColor: '#28a745',
backgroundColor: gradient,
borderWidth: 3,
pointBackgroundColor: '#fff',
pointBorderColor: '#28a745',
pointRadius: 4,
fill: true,
tension: 0.4 // Smooth curve
}]
},
options: {
responsive: true,
maintainAspectRatio: false, // Fits the container height
scales: {
y: {
beginAtZero: true,
grid: { borderDash: [2, 2] },
ticks: { callback: function(value) { return 'Rs ' + value; } }
},
x: { grid: { display: false } }
},
plugins: {
legend: { display: false },
tooltip: {
mode: 'index',
intersect: false,
backgroundColor: 'rgba(0,0,0,0.8)',
callbacks: { label: function(c) { return ' Rs ' + c.parsed.y; } }
}
}
}
});
}
// ------------------------------------------------
// 2. ENROLLMENT CHART (Blue Bar Theme)
// ------------------------------------------------
const enrollCtx = document.getElementById('enrollmentChart');
if (enrollCtx) {
// Placeholder data if variables aren't passed yet
const enrollLabels = document.getElementById('enrollment-labels')
? JSON.parse(document.getElementById('enrollment-labels').textContent)
: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'];
const enrollData = document.getElementById('enrollment-data')
? JSON.parse(document.getElementById('enrollment-data').textContent)
: [12, 19, 3, 5, 2, 3];
new Chart(enrollCtx.getContext('2d'), {
type: 'bar',
data: {
labels: enrollLabels,
datasets: [{
label: 'New Students',
data: enrollData,
backgroundColor: '#3498db', // Blue
borderRadius: 4, // Rounded bars
barPercentage: 0.6
}]
},
options: {
responsive: true,
maintainAspectRatio: false,
scales: {
y: {
beginAtZero: true,
grid: { borderDash: [2, 2] }
},
x: { grid: { display: false } }
},
plugins: { legend: { display: false } }
}
});
}
});
        </script>
    </div>
    <!-- /.page -->
{% endblock content %}
{% block bottomjs %}
{% endblock bottomjs %}

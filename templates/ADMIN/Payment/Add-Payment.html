{% extends "base.html" %}
{% block extrastyles %}
{% endblock extrastyles %}
{% block extrajs %}
{% endblock extrajs %}
{% block content %}
    <!-- Page Header & Breadcrumbs -->
    <header class="">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="{% url 'AdminDashboard' %}">DataManagement</a>
                </li>
                <li class="breadcrumb-item">
                    <a href="{% url 'ViewPayment' %}">Finance</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">Add Payment</li>
            </ol>
        </nav>
        <div class="d-flex justify-content-between align-items-center">
            <h1 class="page-title">Record New Payment</h1>
        </div>
    </header>
    {% comment %} message {% endcomment %}
    {% if messages %}
        {% for message in messages %}
            <div class="alert {% if message.tags == 'success' %}alert-success {% elif message.tags == 'error' %}alert-danger {% elif message.tags == 'warning' %}alert-warning {% elif message.tags == 'info' %}alert-info {% elif message.tags == 'debug' %}alert-secondary {% else %}alert-primary {% endif %}"
                 role="alert">{{ message }}</div>
        {% endfor %}
    {% endif %}
    <!-- Page Content Section -->
    <div class="page-section">
        <div class="row">
            <!-- Center the form nicely -->
            <div class="col-12 col-sm-12 col-lg-12 border rounded mb-5 mb-sm-5 bg-white">
                <div class="card-body">
                    <!-- Form -->
                    <form method="post">
                        {% csrf_token %}
                        <!-- SECTION 1: Payer Details -->
                        <fieldset>
                            <legend>Payer Information</legend>
                            <!-- Student Selection -->
                            <div class="form-group">
                                <label for="id_student">
                                    Student <abbr title="Required">*</abbr>
                                </label>
                                <select class="form-control" id="id_student" name="student">
                                    <option value=""  selected>Select Student</option>
                                    {% for std in students %}<option value="{{ std.id }}">{{ std.full_name }}</option>{% endfor %}
                                </select>
                            </div>
                            <!-- Enrollment Selection (Optional but recommended) -->
                            <div class="form-group">
                                <label for="id_enrollment">Linked Enrollment</label>
                                <select class="form-control" id="id_enrollment" name="enrollment">
                                    <option value="">Select Enrollment</option>
                                    {% for enroll in enrollments %}
                                        <option value="{{ enroll.id }}">
                                            Student:
                                            {% if enroll.student %}
                                                {{ enroll.student.full_name }}
                                            {% else %}
                                                Student Deleted
                                            {% endif %}
                                            |
                                            Batch:
                                            {% if enroll.batch %}
                                                {{ enroll.batch.name }}
                                            {% else %}
                                                No Batch
                                            {% endif %}
                                        </option>
                                    {% endfor %}
                                </select>
                                <small class="form-text text-muted">Select which course/batch this payment is for.</small>
                            </div>
                        </fieldset>
                        <hr class="my-4">
                        <!-- SECTION 2: Transaction Details -->
                        <fieldset>
                            <legend>Transaction Details</legend>
                            <div class="row">
                                <!-- Amount -->
                                <div class="col-md-6 mb-3">
                                    <label for="id_amount">
                                        Amount (Rs.) <abbr title="Required">*</abbr>
                                    </label>
                                    <input type="number"
                                           class="form-control"
                                           id="id_amount"
                                           name="amount"
                                           step="0.01"
                                           min="0"
                                           placeholder="e.g. 5000.00"
                                           required>
                                </div>
                                <!-- Payment Method -->
                                <div class="col-md-6 mb-3">
                                    <label for="id_method">Payment Method</label>
                                    <select class="form-control" id="id_method" name="method">
                                        <option value="CASH" selected>Cash</option>
                                        <option value="ESEWA">eSewa</option>
                                        <option value="BANK">Bank Transfer</option>
                                        <option value="OTHERS">Others</option>
                                    </select>
                                </div>
                            </div>
                            <!-- Reference Number -->
                            <div class="form-group">
                                <label for="id_ref_no">Reference / Transaction No.</label>
                                <input type="text"
                                       class="form-control"
                                       id="id_ref_no"
                                       name="ref_no"
                                       placeholder="e.g. ESW-123456 or CHQ-998877">
                                <small class="form-text text-muted">Required for Bank/Online transfers.</small>
                            </div>
                            <!-- Remarks -->
                            <div class="form-group">
                                <label for="id_remarks">Remarks</label>
                                <textarea class="form-control"
                                          id="id_remarks"
                                          name="remarks"
                                          rows="3"
                                          placeholder="e.g. First installment paid by father."></textarea>
                            </div>
                            <!-- Action Buttons -->
                            <div class="d-flex flex-column mt-4">
                                <button type="submit" class="btn btn-outline-primary w-100">Save Payment</button>
                            </div>
                        </fieldset>
                    </form>
                    <!-- /.form -->
                </div>
            </div>
        </div>
    </div>
{% endblock content %}
{% block bottomjs %}
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const studentSelect = document.getElementById('id_student');
        const enrollmentSelect = document.getElementById('id_enrollment');

        // 1. Sidebar Fix (From previous context - keeps sidebar active)
        const targetUrl = "{% url 'ViewPayment' %}"; 
        const activeLink = document.querySelector(`#stacked-menu .menu-link[href="${targetUrl}"]`);
        if (activeLink) {
            activeLink.classList.add('active');
            const parentItem = activeLink.closest('.menu-item');
            if (parentItem) parentItem.classList.add('has-active');
            const parentMenu = activeLink.closest('ul.menu');
            if (parentMenu && parentMenu.parentElement) {
                parentMenu.parentElement.classList.add('has-active', 'has-open');
            }
        }

        // 2. Mutual Exclusivity Logic (Student vs Enrollment)
        function toggleFields() {
            const studentVal = studentSelect.value;
            const enrollmentVal = enrollmentSelect.value;

            // Scenario A: Student is selected
            if (studentVal !== "") {
                enrollmentSelect.disabled = true;
                enrollmentSelect.value = ""; // Clear enrollment selection
            } 
            // Scenario B: Enrollment is selected
            else if (enrollmentVal !== "") {
                studentSelect.disabled = true;
                studentSelect.value = ""; // Clear student selection
                
                // CRITICAL: If student is disabled, we must remove 'required' 
                // or the browser won't let you submit the form.
                studentSelect.removeAttribute('required');
            } 
            // Scenario C: Both are empty (Reset)
            else {
                studentSelect.disabled = false;
                enrollmentSelect.disabled = false;
                
                // Re-add required to student as it is the default mandatory field
                studentSelect.setAttribute('required', 'required');
            }
        }

        // Listen for changes on both fields
        studentSelect.addEventListener('change', toggleFields);
        enrollmentSelect.addEventListener('change', toggleFields);
    });
    </script>
{% endblock bottomjs %}

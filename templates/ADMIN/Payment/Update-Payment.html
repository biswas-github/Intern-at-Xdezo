{% extends "base.html" %}
{% block extrastyles %}
{% endblock extrastyles %}
{% block extrajs %}
{% endblock extrajs %}
{% block content %}
    <!-- Page Header & Breadcrumbs -->
    <header class="">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="{% url 'AdminDashboard' %}">DataManagement</a>
                </li>
                <li class="breadcrumb-item">
                    <a href="{% url 'ViewPayment' %}">Finance</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">Update Payment</li>
            </ol>
        </nav>
        <div class="d-flex justify-content-between align-items-center">
            <h1 class="page-title">Update Payment Details</h1>
        </div>
    </header>
    <!-- Page Content Section -->
    <div class="page-section">
        <div class="row">
            <div class="col-12 col-sm-12 col-lg-12 border rounded mb-5 mb-sm-5 bg-white">
                <div class="card-body">
                    <!-- Form -->
                    <form method="post">
                        {% csrf_token %}
                        <!-- SECTION 1: Payer Details -->
                        <fieldset>
                            <legend>Payer Information</legend>
                            <!-- Student Selection -->
                            <div class="form-group">
                                <label for="id_student">
                                    Student <abbr title="Required">*</abbr>
                                </label>
                                <!-- NOTE: Removed 'disabled' from the first option so user can reset selection -->
                                <select class="form-control" id="id_student" name="student" required>
                                    <option value="">Select Student (General)</option>
                                    {% for std in students %}
                                        <option value="{{ std.id }}"
                                                {% if std.id == payment.student.id %}selected{% endif %}>
                                            {{ std.full_name }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <!-- Enrollment Selection -->
                            <div class="form-group">
                                <label for="id_enrollment">Linked Enrollment (Batch)</label>
                                <select class="form-control" id="id_enrollment" name="enrollment">
                                    <option value="">-- No Enrollment --</option>
                                    {% for enroll in enrollments %}
                                        <option value="{{ enroll.id }}"
                                                {% if payment.enrollment and enroll.id == payment.enrollment.id %}selected{% endif %}>
                                            {{ enroll.student.full_name }} - {{ enroll.batch.name }}
                                        </option>
                                    {% endfor %}
                                </select>
                                <small class="form-text text-muted">Select this if payment is for a specific batch.</small>
                            </div>
                        </fieldset>
                        <hr class="my-4">
                        <!-- SECTION 2: Transaction Details -->
                        <fieldset>
                            <legend>Transaction Details</legend>
                            <div class="row">
                                <!-- Amount -->
                                <div class="col-md-6 mb-3">
                                    <label for="id_amount">
                                        Amount (Rs.) <abbr title="Required">*</abbr>
                                    </label>
                                    <input type="number"
                                           class="form-control"
                                           id="id_amount"
                                           name="amount"
                                           step="0.01"
                                           min="0"
                                           value="{{ payment.amount|stringformat:'.2f' }}"
                                           required>
                                </div>
                                <!-- Payment Method -->
                                <div class="col-md-6 mb-3">
                                    <label for="id_method">Payment Method</label>
                                    <select class="form-control" id="id_method" name="method">
                                        <option value="CASH" {% if payment.method == 'CASH' %}selected{% endif %}>Cash</option>
                                        <option value="ESEWA" {% if payment.method == 'ESEWA' %}selected{% endif %}>eSewa</option>
                                        <option value="BANK" {% if payment.method == 'BANK' %}selected{% endif %}>Bank Transfer</option>
                                        <option value="OTHERS" {% if payment.method == 'OTHERS' %}selected{% endif %}>Others</option>
                                    </select>
                                </div>
                            </div>
                            <!-- Transaction Date (Read Only) -->
                            <div class="form-group">
                                <label for="id_date">Transaction Date</label>
                                <input type="text"
                                       class="form-control"
                                       id="id_date"
                                       value="{{ payment.date }}"
                                       disabled>
                                <small class="form-text text-muted">Original payment date cannot be modified.</small>
                            </div>
                            <!-- Reference Number -->
                            <div class="form-group">
                                <label for="id_ref_no">Reference / Transaction No.</label>
                                <input type="text"
                                       class="form-control"
                                       id="id_ref_no"
                                       name="ref_no"
                                       value="{{ payment.ref_no|default:'' }}">
                            </div>
                            <!-- Remarks -->
                            <div class="form-group">
                                <label for="id_remarks">Remarks</label>
                                <textarea class="form-control" id="id_remarks" name="remarks" rows="3">{{ payment.remarks|default:'' }}</textarea>
                            </div>
                            <!-- Action Buttons -->
                            <div class="d-flex flex-column mt-4">
                                <button type="submit" class="btn btn-outline-primary w-100">Update Payment</button>
                            </div>
                        </fieldset>
                    </form>
                </div>
            </div>
        </div>
    </div>
{% endblock content %}
{% block bottomjs %}
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const studentSelect = document.getElementById('id_student');
        const enrollmentSelect = document.getElementById('id_enrollment');

        // 1. Sidebar Fix (Keep 'Finance > Payments' active)
        const targetUrl = "{% url 'ViewPayment' %}"; 
        const activeLink = document.querySelector(`#stacked-menu .menu-link[href="${targetUrl}"]`);
        if (activeLink) {
            activeLink.classList.add('active');
            const parentItem = activeLink.closest('.menu-item');
            if (parentItem) parentItem.classList.add('has-active');
            const parentMenu = activeLink.closest('ul.menu');
            if (parentMenu && parentMenu.parentElement) {
                parentMenu.parentElement.classList.add('has-active', 'has-open');
            }
        }

        // 2. Toggle Logic
        function toggleFields() {
            const sVal = studentSelect.value;
            const eVal = enrollmentSelect.value;

            // Scenario A: Enrollment is selected (Has priority)
            if (eVal !== "") {
                studentSelect.value = ""; // Clear visual value
                studentSelect.disabled = true; // Disable interaction
                studentSelect.removeAttribute('required'); // Remove validation
            } 
            // Scenario B: Student is selected
            else if (sVal !== "") {
                enrollmentSelect.value = ""; // Clear visual value
                enrollmentSelect.disabled = true; // Disable interaction
            }
            // Scenario C: Both empty (Reset state)
            else {
                studentSelect.disabled = false;
                enrollmentSelect.disabled = false;
                studentSelect.setAttribute('required', 'required'); // Re-enable validation
            }
        }

        // 3. Event Listeners
        studentSelect.addEventListener('change', toggleFields);
        enrollmentSelect.addEventListener('change', toggleFields);

        // 4. Initial Run (Check Database Values)
        toggleFields();
    });
    </script>
{% endblock bottomjs %}
